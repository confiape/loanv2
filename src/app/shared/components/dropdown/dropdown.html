<div
  class="relative inline-flex"
  [class.w-full]="trigger().fullWidth"
  (mouseenter)="handleHostMouseEnter()"
  (mouseleave)="handleHostMouseLeave()"
>
  <button
    type="button"
    [attr.data-testid]="triggerTestId()"
    [attr.aria-expanded]="isOpen()"
    [attr.aria-label]="trigger().ariaLabel || trigger().label"
    [attr.aria-haspopup]="true"
    [class]="triggerClasses()"
    (click)="onTriggerClick($event)"
    (keydown)="onTriggerKeydown($event)"
  >
    <span class="flex items-center gap-2 truncate">
      @if (trigger().leadingIcon) {
        <span class="flex items-center justify-center">
          <ng-container
            *ngTemplateOutlet="
              iconTpl;
              context: { icon: trigger().leadingIcon, classes: triggerIconClass() }
            "
          ></ng-container>
        </span>
      }
      @if (trigger().label) {
        <span class="truncate">{{ trigger().label }}</span>
      }
      @if (trigger().trailingIcon ?? fallbackTrailingIcon()) {
        <span class="flex items-center justify-center">
          <ng-container
            *ngTemplateOutlet="
              iconTpl;
              context: {
                icon: trigger().trailingIcon ?? fallbackTrailingIcon(),
                classes: triggerIconClass()
              }
            "
          ></ng-container>
        </span>
      }
    </span>
  </button>

  @if (isOpen()) {
    <div
      class="absolute z-20 mt-2"
      [class.end-0]="isPlacementEndAligned()"
      [class.start-0]="!isPlacementEndAligned()"
      [class.mb-2]="isPlacementTop()"
      [class.mt-2]="!isPlacementTop()"
      [class.bottom-full]="isPlacementTop()"
      [class.top-full]="!isPlacementTop()"
    >
      <div
        class="rounded-lg border border-border bg-bg-primary shadow-lg"
        [style.width.px]="panelWidthPx()"
        [style.maxHeight.px]="panelMaxHeightPx()"
        [attr.data-testid]="panelTestId()"
        [class.overflow-y-auto]="shouldScroll()"
        (mouseenter)="panelHovering.set(true)"
        (mouseleave)="panelHovering.set(false)"
      >
        <!-- Header -->
        @if (header()) {
          <div class="px-4 py-3 border-b border-border">
            <div class="flex items-center gap-3">
              @if (header()?.avatar?.imageUrl) {
                <img
                  class="h-8 w-8 rounded-full object-cover"
                  [src]="header()?.avatar?.imageUrl"
                  [alt]="header()?.avatar?.name"
                />
              } @else if (header()?.avatar?.initials) {
                <div class="h-8 w-8 rounded-full bg-bg-secondary flex items-center justify-center text-sm font-medium text-text-primary">
                  {{ header()?.avatar?.initials }}
                </div>
              }
              <div class="min-w-0">
                <p class="text-sm font-medium text-text-primary leading-tight">
                  {{ header()?.title }}
                </p>
                @if (header()?.subtitle) {
                  <p class="text-xs text-text-secondary leading-tight">
                    {{ header()?.subtitle }}
                  </p>
                }
                @if (header()?.helperText) {
                  <p class="mt-1 text-xs text-text-secondary leading-tight">
                    {{ header()?.helperText }}
                  </p>
                }
              </div>
            </div>
          </div>
        }

        <!-- Search -->
        @if (searchConfig()) {
          <div class="border-b border-border px-4 py-3">
            <label class="sr-only">{{ searchConfig()?.ariaLabel || searchConfig()?.placeholder }}</label>
            <div class="relative">
              <span class="pointer-events-none absolute inset-y-0 start-3 flex items-center text-text-secondary">
                <ng-container
                  *ngTemplateOutlet="
                    iconTpl;
                    context: { icon: 'search', classes: 'text-text-secondary' }
                  "
                ></ng-container>
              </span>
              <input
                type="text"
                class="w-full rounded-md border border-border bg-bg-secondary py-2 ps-9 pe-3 text-sm text-text-primary placeholder-text-secondary focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent"
                [placeholder]="searchConfig()?.placeholder"
                [value]="searchTerm()"
                (input)="onSearch($event)"
              />
            </div>
          </div>
        }

        <!-- Sections -->
        <div [class.max-h-full]="!panelMaxHeightPx()">
          <ng-container
            *ngTemplateOutlet="
              sectionTpl;
              context: { sections: visibleSections(), path: [] }
            "
          ></ng-container>
        </div>

        <!-- Footer -->
        @if (footerAction()) {
          <div class="border-t border-border bg-bg-secondary">
            <ng-container
              *ngTemplateOutlet="footerTpl; context: { action: footerAction() }"
            ></ng-container>
          </div>
        }
      </div>
    </div>
  }
</div>

<!-- Icon template -->
<ng-template #iconTpl let-icon="icon" let-classes="classes">
  @switch (icon) {
    @case ('chevron-down') {
      <svg
        class="h-4 w-4"
        [ngClass]="classes ?? 'text-text-secondary'"
        viewBox="0 0 20 20"
        fill="none"
        aria-hidden="true"
      >
        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    }
    @case ('chevron-right') {
      <svg
        class="h-4 w-4"
        [ngClass]="classes ?? 'text-text-secondary'"
        viewBox="0 0 20 20"
        fill="none"
        aria-hidden="true"
      >
        <path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    }
    @case ('chevron-left') {
      <svg
        class="h-4 w-4"
        [ngClass]="classes ?? 'text-text-secondary'"
        viewBox="0 0 20 20"
        fill="none"
        aria-hidden="true"
      >
        <path d="M12.5 5L7.5 10L12.5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    }
    @case ('dots-vertical') {
      <svg
        class="h-5 w-5"
        [ngClass]="classes ?? 'text-text-secondary'"
        viewBox="0 0 4 15"
        fill="currentColor"
        aria-hidden="true"
      >
        <path d="M3.5 1.5A1.5 1.5 0 1 1 .5 1.5a1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
      </svg>
    }
    @case ('dots-horizontal') {
      <svg
        class="h-5 w-5"
        [ngClass]="classes ?? 'text-text-secondary'"
        viewBox="0 0 16 3"
        fill="currentColor"
        aria-hidden="true"
      >
        <path d="M2 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Zm6.041 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM14 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Z" />
      </svg>
    }
    @case ('plus') {
      <svg
        class="h-4 w-4"
        [ngClass]="classes ?? 'text-text-primary'"
        viewBox="0 0 20 20"
        fill="currentColor"
        aria-hidden="true"
      >
        <path d="M10 4a1 1 0 0 1 1 1v4h4a1 1 0 0 1 0 2h-4v4a1 1 0 1 1-2 0v-4H5a1 1 0 1 1 0-2h4V5a1 1 0 0 1 1-1Z" />
      </svg>
    }
    @case ('minus') {
      <svg
        class="h-4 w-4"
        [ngClass]="classes ?? 'text-text-primary'"
        viewBox="0 0 20 20"
        fill="currentColor"
        aria-hidden="true"
      >
        <path d="M5 9a1 1 0 1 0 0 2h10a1 1 0 1 0 0-2H5Z" />
      </svg>
    }
    @case ('search') {
      <svg
        class="h-4 w-4"
        [ngClass]="classes ?? 'text-text-secondary'"
        viewBox="0 0 20 20"
        fill="none"
        aria-hidden="true"
      >
        <path
          d="m17 17-3.5-3.5m0 0a5 5 0 1 0-7.071-7.071 5 5 0 0 0 7.071 7.071Z"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    }
    @default {
      <span class="block h-4 w-4"></span>
    }
  }
</ng-template>

<!-- Section template -->
<ng-template #sectionTpl let-sections="sections" let-path="path">
  @for (section of sections; track section.id) {
    <div class="px-2 py-2">
      @if (section.title) {
        <p class="px-2 pb-1 text-xs font-semibold uppercase tracking-wide text-text-secondary">
          {{ section.title }}
        </p>
      }
      @if (section.description) {
        <p class="px-2 pb-2 text-xs text-text-secondary">
          {{ section.description }}
        </p>
      }

      <ng-container
        *ngTemplateOutlet="
          itemTpl;
          context: {
            items: section.items,
            path: path,
            sectionId: section.id
          }
        "
      ></ng-container>
    </div>

    @if (section.separatorAfter) {
      <div class="my-1 h-px bg-border"></div>
    }
  }
</ng-template>

<!-- Item template -->
<ng-template #itemTpl let-items="items" let-path="path" let-sectionId="sectionId">
  <ul class="flex flex-col gap-0.5">
    @for (item of items; track item.id) {
      @switch (item.type) {
        @case ('divider') {
          <li>
            <div
              class="mx-2 my-1 h-px bg-border"
              [class.my-0]="item.spacing === 'compact'"
            ></div>
          </li>
        }
        @case ('submenu') {
          @let currentPath = buildPath(path, sectionId, item.id);
          <li
            class="relative"
            (mouseenter)="openSubmenu(currentPath)"
            (focusin)="openSubmenu(currentPath)"
          >
            <button
              type="button"
              class="flex w-full items-center justify-between rounded-md px-3 py-2 text-sm text-text-primary hover:bg-bg-secondary focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
              (click)="onItemSelect(item, currentPath, $event)"
            >
              <span class="flex items-center gap-2">
                {{ item.label }}
              </span>
              <ng-container
                *ngTemplateOutlet="
                  iconTpl;
                  context: { icon: 'chevron-right', classes: 'text-text-secondary' }
                "
              ></ng-container>
            </button>

            @if (isPathActive(currentPath)) {
              <div
                class="absolute start-full top-0 z-30 ms-2"
                [style.width.px]="panelWidthPx()"
              >
                <div class="rounded-lg border border-border bg-bg-primary shadow-lg">
                  <ng-container
                    *ngTemplateOutlet="
                      itemTpl;
                      context: {
                        items: item.children,
                        path: currentPath,
                        sectionId: sectionId
                      }
                    "
                  ></ng-container>
                </div>
              </div>
            }
          </li>
        }
        @case ('checkbox') {
          @let currentPath = buildPath(path, sectionId, item.id);
          <li>
            <label
              class="flex cursor-pointer items-center gap-2 rounded-md px-3 py-2 text-sm text-text-primary hover:bg-bg-secondary"
            >
              <input
                type="checkbox"
                class="h-4 w-4 rounded border-border text-accent focus:ring-2 focus:ring-accent"
                [checked]="isCheckboxChecked(item)"
                (change)="onCheckboxToggle(item, currentPath, $event)"
                [disabled]="item.disabled"
              />
              <span class="flex-1">
                <span>{{ item.label }}</span>
                @if (item.description) {
                  <span class="block text-xs text-text-secondary">{{ item.description }}</span>
                }
              </span>
              @if (item.meta) {
                <span class="text-xs text-text-secondary">{{ item.meta }}</span>
              }
            </label>
          </li>
        }
        @case ('user') {
          @let currentPath = buildPath(path, sectionId, item.id);
          <li>
            <button
              type="button"
              class="flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm text-text-primary hover:bg-bg-secondary focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
              (click)="onItemSelect(item, currentPath, $event)"
            >
              <img
                class="h-6 w-6 rounded-full object-cover"
                [src]="item.avatar.imageUrl"
                [alt]="item.avatar.name"
              />
              <span class="flex-1 text-start">{{ item.label }}</span>
              @if (item.meta) {
                <span class="text-xs text-text-secondary">{{ item.meta }}</span>
              }
            </button>
          </li>
        }
        @default {
          @let currentPath = buildPath(path, sectionId, item.id);
          <li>
            <button
              type="button"
              class="flex w-full items-center justify-between rounded-md px-3 py-2 text-sm text-text-primary hover:bg-bg-secondary focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
              [class.opacity-50]="item.disabled"
              [class.cursor-not-allowed]="item.disabled"
              (click)="onItemSelect(item, currentPath, $event)"
              [disabled]="item.disabled"
            >
              <span class="flex items-center gap-2">
                {{ item.label }}
                @if (item.description) {
                  <span class="block text-xs text-text-secondary">{{ item.description }}</span>
                }
              </span>
              @if (item.meta) {
                <span class="text-xs text-text-secondary">{{ item.meta }}</span>
              }
            </button>
          </li>
        }
      }
    }
  </ul>
</ng-template>

<!-- Footer template -->
<ng-template #footerTpl let-action="action">
  <a
    class="flex items-center gap-2 px-4 py-3 text-sm font-medium"
    [class.text-accent]="action.intent === 'accent'"
    [class.text-error]="action.intent === 'danger'"
    [class.text-text-primary]="action.intent === 'default' || !action.intent"
    [href]="action.href || '#'"
    (click)="onFooterClick($event, action)"
  >
    @if (action.icon) {
      <ng-container
        *ngTemplateOutlet="
          iconTpl;
          context: { icon: action.icon, classes: footerIconClass(action) }
        "
      ></ng-container>
    }
    <span>{{ action.label }}</span>
  </a>
</ng-template>
